# 基础执知识

## windows 操作系统

早期 windows 主要部分只需要在 3 个动态库中实现：

- KERNEL32.dll: 操作系统核心功能服务、包括进程与线程控制、内存管理、文件访问等。
- USER32.dll: 负责处理用户接口、包括键盘和鼠标输入、窗口和菜单管理等。
- GDI32.dll: 图形设备接口，允许程序在屏幕和打印机上显示文本和图形。

除此之外还有其他的一些动态库支持更多功能：

- ADVAPI32.dll: 对象安全性、注册表操作。
- COMCTL32.dll: 通用控件。
- COMDLG32.dll: 公共对话框。
- SHELL32.dll: 用户界面外壳。
- NETAPI32.dll

### WOW64

WOW64 是 64 位操作系统的子系统，可以使大多数 32 位应用程序不经修改的情况下运行在 64 位操作系统上。

64 位系统上，`Windows/System32` 目录中包含原生的 64 位映像文件；`Windows/SysWOW64` 目录中存储了 32 位的系统文件。

### 消息基址

Windows 是一个消息驱动式系统，有两种消息队列：

1. 系统消息队列。
1. 应用程序消息队列。

当事件发生时，先将消息反倒系统消息队列，再复制到应用程序队列中，应用程序的消息循环处理消息。

### 虚拟内存

默认情况下，32 位 Windows 操作系统的地址空间在 4GB 以内，平坦内存模式使每个进程都拥有自己的虚拟空间，其大小为 4GB；正好 32 位的指针也可以访问 4GB 的空间，所以就不需要区分代码段和数据段。

操作系统的 dll 一直被映射到真实的内存，应用程序的 dll 则有选则的映射。

1. 应用程序启动时，系统创建一个进程，并给该进程分配 2GB 的虚拟地址空间。
1. 虚拟内存管理器将应用程序的代码、数据、堆、栈、模块映射到虚拟地址空间，并且把当前需要的代码读入物理内存地址。
1. 如果使用 dll, 也会将其映射到进程的虚拟地址空间中，在需要时才会被读入物理内存。
1. 其他项目的空间时从物理空间分配，并被映射到虚拟地址空间中。
1. 应用程序通过使用其虚拟地址空间中的地址开始执行，然后虚拟内存管理器把该地址映射到物理地址中。

# 动态分析技术

## x64dbg

### 基本操作

| 快捷键  | 功能                                 |
| ------- | ------------------------------------ |
| F7      | 单步步进，遇到 call 指令跟进。       |
| F8      | 单步步过，遇到 call 指令路过，不跟进 |
| Ctrl+F7 | 自动步进，遇到断点或 F12 才暂停      |
| Ctrl+F8 | 自动步过，遇到断点或 F12 才暂停      |
| Ctrl+F9 | 直到出现 ret 指令时中断              |
| Alt+F9  | 返回到应用程序模块                   |
| F9      | 运行程序                             |
| F2      | 设置断点                             |
| Ctrl+N  | 打开当前模块窗口                         |
| Alt+B  | 打开断点窗口                         |

### 断点

1. 内存断点
   在内存窗口选中需要设置断点的地址，右键选择断点 -> 内存，访问/读取/写入/执行。设置好内存断点之后，可以到断点窗口中查看断点信息。可以发现内存断点的地址为 4K 页的起始地址。

2. 条件断点
   在 CPU 界面选中地址，右键选择断点 -> 设置条件断点(Shift+F2)，然后设置断点。
