# LLVM Passes

ä¸€ä¸ª pass æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„å¯é‡ç”¨ç»„ä»¶ï¼Œç”¨äºå¯¹ç¨‹åºçš„ IR æ‰§è¡Œè½¬æ¢æˆ–åˆ†æã€‚

æ ¹æ® [LLVM å®˜æ–¹æ–‡æ¡£](https://llvm.org/docs/Passes.html)ï¼Œpasses æœ‰ä¸¤ç§ä¸»è¦ç±»å‹ï¼š`Analysis Passes` å’Œ `Transform Passes` ã€‚è¿˜æœ‰ä¸€ç±» passes è¢«ç§°ä¸º `Utility Passes` ã€‚

- Analysis Passes ï¼šå®ƒä»¬æ—¨åœ¨æ”¶é›†ä¿¡æ¯å¹¶åˆ†æä»£ç ï¼Œè€Œä¸åšä»»ä½•ä¿®æ”¹ã€‚
- Transform Passes ï¼šå®ƒä»¬æ—¨åœ¨ä¿®æ”¹ç¨‹åºçš„ IRï¼Œä»¥æé«˜æ€§èƒ½ã€å‡å°ä»£ç å¤§å°æˆ–ä¸ºè¿›ä¸€æ­¥ä¼˜åŒ–è®¾ç½®ä»£ç ã€‚

# ç¼–å†™ LLVM passes

åœ¨å®é™…ç¼–å†™ LLVM é€šè¯ä¹‹å‰ï¼Œè¯·å…ˆç†Ÿæ‚‰ C++ ä¸­ Mixins çš„æ¦‚å¿µã€‚[è¿™é‡Œ](https://stackoverflow.com/questions/18773367/what-are-mixins-as-a-concept)æœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£é‡Šã€‚åˆ«å¿˜äº†å®‰è£… llvmã€clang å’Œ cmakeã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ llvm-16ã€‚

```bash
#!/bin/bash
wget https://apt.llvm.org/llvm.sh
chmod +x llvm.sh
./llvm.sh 16
```

è¿è¡Œè¿™äº›å‘½ä»¤å°†å®‰è£… llvm-16ã€clang-16ã€clang++-16 å’Œå…¶ä»–ç›¸å…³å·¥å…·ã€‚LLVM å¤´æ–‡ä»¶å¯èƒ½ä¿å­˜åœ¨ `/usr/include/llvm-16/llvm` ä¸­ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬ç›´æ¥ç§»è‡³ `/usr/includ`e ç›®å½•ï¼Œä»¥æ–¹ä¾¿æ“ä½œã€‚

```bash
mv /usr/include/llvm-16/llvm /usr/include/llvm
mv /usr/include/llvm-c-16/llvm-c /usr/include/llvm-c
```

LLVM åŒ…å«ä¸¤ä¸ª pass ç®¡ç†å™¨ï¼Œå³ä¼ ç»Ÿ pass ç®¡ç†å™¨ï¼ˆlegacy PMï¼‰å’Œæ–° pass ç®¡ç†å™¨ï¼ˆnew PMï¼‰ã€‚ä¸­ç«¯ä½¿ç”¨æ–° pass ç®¡ç†å™¨ï¼Œè€Œåç«¯ä¾èµ–äºç›®æ ‡çš„ä»£ç ç”Ÿæˆåˆ™ä½¿ç”¨ä¼ ç»Ÿ pass ç®¡ç†å™¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿ pass ç®¡ç†å™¨æˆ–æ–° pass ç®¡ç†å™¨æ¥ç¼–å†™ passã€‚åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ–°çš„ pass ç®¡ç†å™¨ã€‚

## ç”¨äºæ‰“å°å‡½æ•°åçš„ LLVM pass

```cpp
#include "llvm/IR/PassManager.h"
#include "llvm/Passes/PassBuilder.h"
#include "llvm/Passes/PassPlugin.h"
#include "llvm/Support/raw_ostream.h"
using namespace llvm;

namespace
{
  // All LLVM passes must inherit from the CRTP mixin PassInfoMixin
  struct FunctionListerPass : public PassInfoMixin<FunctionListerPass>
  {
    // A pass should have a run method
    PreservedAnalyses run(Function &F, FunctionAnalysisManager &FAM)
    {
      // outs() returns a reference to a raw_fd_ostream for standard output.
      outs() << F.getName() << '\n';
      return PreservedAnalyses::all();
    }
  };

}

PassPluginLibraryInfo getPassPluginInfo()
{
  const auto callback = [](PassBuilder &PB)
  {
    PB.registerPipelineStartEPCallback(
        [&](ModulePassManager &MPM, auto)
        {
          MPM.addPass(createModuleToFunctionPassAdaptor(FunctionListerPass()));
          return true;
        });
  };

  return {LLVM_PLUGIN_API_VERSION, "name", "0.0.1", callback};
};

/* When a plugin is loaded by the driver, it will call this entry point to
obtain information about this plugin and about how to register its passes.
*/
extern "C" LLVM_ATTRIBUTE_WEAK PassPluginLibraryInfo llvmGetPassPluginInfo()
{
  return getPassPluginInfo();
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»å°†æ­¤ç¨‹åºç¼–è¯‘ä¸ºå…±äº«åº“ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å®Œæˆç¼–è¯‘ï¼š

```bash
clang-16 -shared -o func_lister.so func_lister.cpp -fPIC
```

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ test.c å¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€äº›ä»£ç ã€‚

```c
// test.c
void testFunctionOne()
{
}

void testFunctionTwo()
{
}

int main()
{
  return 0;
}
```

è¿è¡Œä¸‹é¢çš„å‘½ä»¤å°†è¿è¡Œ passã€‚è¯·æ³¨æ„ï¼Œå¿…é¡»ä½¿ç”¨ -O1 æ ‡å¿—ã€‚ -O2 å’Œ -O3 æ ‡å¿—ä¹ŸåŒæ ·æœ‰æ•ˆã€‚

```bash
clang-16 -O1 -fpass-plugin=./func_lister.so test.c -o test
```

è¿™åªæ˜¯è¿è¡Œä¸€ä¸ªç®€å•çš„ LLVM é€šè¯æ¥æ‰“å°å‡½æ•°åã€‚æºä»£ç ä»¥åŠé¡ºåˆ©è¿è¡Œä¸€åˆ‡çš„ Dockerfile å¯åœ¨æ­¤ [GitHub ä»£ç åº“](https://github.com/0xSh4dy/learning_llvm)ä¸­æ‰¾åˆ°ã€‚åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ LLVM é€šè¯çš„æ›´å¤šç²¾å½©åº”ç”¨ï¼ŒåŒ…æ‹¬åé€†å‘å·¥ç¨‹å’Œä»£ç æ··æ·† ğŸ˜‰ã€‚

# å‚è€ƒ

https://llvm.org/docs/WritingAnLLVMNewPMPass.html

https://blog.llvm.org/posts/2021-03-26-the-new-pass-manager/

https://stackoverflow.com/questions/54447985/how-to-automatically-register-and-load-modern-pass-in-clang
