在编译后的代码中，有时会出现一些并非程序员直接写下的指令，而是编译器为了自身目的或运行环境的要求而插入的。

### Skippable instruction 的类型

编译后的函数通常在开头有 prolog 指令，用于执行各种簿记操作，例如：

- 保存函数体中使用的易失寄存器；
- 为当前函数建立新的栈帧；
- 为局部变量分配栈空间；
- 初始化 stack cookie 以检测缓冲区溢出；
- 为当前函数设置异常处理程序。

类似地，函数的 `epilog` 在返回调用者之前执行相反的操作。

在 `switch` 模式 下，也可能存在一些仅用于确定间接跳转目标的指令，它们并不代表实际的业务逻辑。

为了避免在反编译时浪费时间分析这些样板代码，反编译器依赖处理器模块来标记这些指令。

### 显示 Skippable instructions

默认情况下，被跳过的指令在视觉上没有任何区别。 要启用可视化，可以创建一个名为 `idauser.cfg` 的文本文件，内容如下：

```c
#ifdef __GUI__
PROLOG_COLOR = 0xE0E0E0 // grey
EPILOG_COLOR = 0xE0FFE0 // light green
SWITCH_COLOR = 0xE0E0FF // pink
#endif
```

将该文件放在用户目录下：

- Windows: `%appdata%\\Hex-Rays\\IDA Pro`
- Unix: `$HOME/.idapro`

然后重启 IDA 或重新加载数据库，就能在反汇编列表中看到效果。

原始反汇编：

![](assets/2021/12/skipped_unmarked.png)

创建配置文件后：

![](assets/2021/12/skipped_marked.png)

可以看到，前 3 条和最后 2 条指令会以指定颜色高亮显示。 这些指令在反编译时会被跳过。

### 修改 Skippable instructions

有时需要手动调整 IDA 对跳过指令的判断。 例如，IDA 可能未能将某些寄存器保存标记为 `prolog` 的一部分（这可能导致伪代码中出现访问未初始化变量的情况）。

此时可以手动修正：

- 在反汇编视图中选择需要标记的指令；
- 执行 `Edit > Other > Toggle skippable instructions…`；
- 选择类别（`prolog`/`epilog`/`switch`），点击` OK`。

如果遇到相反的情况（IDA 错误地标记了实际有用的指令），执行相同步骤即可取消标记。 在这种情况下，第 3 步不会弹出对话框，指令会直接被取消标记。

更多信息: [Toggle skippable instructions (Decompiler Manual)](https://hex-rays.com/products/decompiler/manual/interactive.shtml#06)

原文地址：https://hex-rays.com/blog/igors-tip-of-the-week-68-skippable-instructions
