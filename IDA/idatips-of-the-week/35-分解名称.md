名称修饰（`Name mangling`，也称 `name decoration`）是编译器用来实现某些语言特性的技术。 例如，在 C++ 中，它用于区分同名但参数不同的函数（函数重载），以及支持命名空间、模板等功能。

被修饰的名称通常会出现在最终的二进制文件中，并且根据编译器不同，可能很难让人直接看懂（例如 `operator new` 可能会被编码为 `??2@YAPAXI@Z` 或 `_Znwm`）。

虽然这些字符串可以用编译器提供的工具（如 MSVC 的 `undname` 或 `GCC/Clang` 的 `c++filt`）解码，但如果反汇编器能自动完成就更方便（尤其是在没有安装编译器的情况下）。 将修饰过的名称解码回可读形式的过程称为 反混淆（`demangling`）。

### IDA 支持的反混淆

IDA 内置支持以下编译器和语言的名称反混淆：

- Microsoft (Visual C++)
- Borland (C++、Pascal、C++ Builder、Delphi)
- Watcom (C++)
- Visual Age (C++)
- DMD (D 语言)
- GNU 名称修饰（GCC、Clang 及部分商业编译器）
- Swift

你无需手动选择编译器，IDA 会根据名称格式自动检测并调用对应的反混淆器。

### 反混淆名称的显示方式

默认情况下，IDA 会将反混淆结果显示为注释，也就是说，每次使用到被修饰的名称时，IDA 会在旁边打印反混淆结果。

例如： `?FromHandle@CGdiObject@@SGPAV1@PAX@Z` 会被反混淆为： `CGdiObject::FromHandle(void *)` 并作为注释显示。

![](assets/2021/04/demangled_comment.png)

如果你希望直接用反混淆结果替换原始名称（而不是仅作为注释显示），可以在 `Options > Demangled names…` 对话框中设置。

![](assets/2021/04/demangled_names.png)

![](assets/2021/04/demangled_name-300x249.png)

### 短名称与长名称

“Setup short names”和“Setup long names”按钮允许你调整内置反混淆器在两种常见场景下的行为：

- 短名称：用于空间有限的地方，例如反汇编引用、函数列表等
- 长名称：用于其他场景，例如函数开头的注释

通过额外的选项对话框，你可以选择在反混淆结果中显示、隐藏或缩短哪些部分，从而让名称更紧凑或更详细。

![](assets/2021/04/demangled_short.png)

### 名称简化（Name simplification）

一些看似简单的名称在编译后可能变得非常复杂，尤其是涉及模板时。

例如，STL 中的 [std::string](https://en.cppreference.com/w/cpp/string) 实际会展开为：

```cpp
std::basic_string<char,std::char_traits<char>,std::allocator<char>>
```

为了保证互操作性，编译器必须在修饰名中保留这些细节，因此反混淆后它们会重新出现。 但对人类读者来说，这些实现细节通常并不重要，更希望看到简洁的 `std::string`。

因此，IDA 在反混淆后会进行名称简化的后处理。 它会根据 `cfg/goodname.cfg` 文件中的规则，将类似：

```cpp
std::basic_string<char,struct std::char_traits<char>,class std::allocator<char> > & __thiscall std::basic_string<char,struct std::char_traits<char>,class std::allocator<char> >::erase(unsigned int,unsigned int)

```

转换为：

```cpp
std::string & std::string::erase(unsigned int,unsigned int)
```

这样更易读。

IDA 自带了大多数标准 STL 类的规则，你也可以添加自定义规则。 具体方法可参考 `goodname.cfg` 文件中的注释说明。

更多信息：IDA 帮助中的[拆分名称](https://www.hex-rays.com/products/ida/support/idadoc/611.shtml)。

原文地址：https://hex-rays.com/blog/igors-tip-of-the-week-35-demangled-names
