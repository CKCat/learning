有时你知道结构体的大小，但还不知道它的具体布局。例如，当为结构体分配的内存大小是固定的情况下：

![](assets/2020/10/strsize1.png)

在这种情况下，你可以快速创建一个占位（dummy）结构体，然后在分析使用它的代码时逐步修改。

这里有几种可用的方法。

### 固定大小结构体方法 1：单个数组

这是最快的方法，但在修改结构体时会稍显麻烦。

1. 创建结构体（进入 `Structures` 视图，按 `Ins` 并指定名称）；
2. 创建数组（将光标定位到结构体起始位置，按 `*` 并输入大小（十进制或十六进制））；

   ![](assets/2020/10/strsize2-e1603441294648.png)

   ![](assets/2020/10/strsize3.png)

3. 当需要在中间创建字段时，按 `*` 调整数组大小，使其在字段前结束；
4. 创建字段；
5. 再在字段后创建另一个数组，将结构体填充到完整大小。

### 固定大小结构体方法 2：中间留大空隙

1. 创建结构体（进入 `Structures` 视图，按 `Ins` 并指定名称）；
1. 创建一个字节字段（按 `D`）；
1. 添加空隙（`Ctrl-E` 或右键菜单中选择 `Expand struct type…`），输入大小减 1；
1. 在现在位于结构体末尾的 `field_0` 上按 `N`、`Del`、`Enter`，将其名称重置为与实际偏移匹配，这样如果需要在偏移 0 再创建一个 `field_0` 时不会冲突；
   ![](assets/2020/10/strsize4.png)
   ![](assets/2020/10/strsize5.png)
1. 要在空隙中间创建字段，可以直接跳转到结构体的特定偏移（对于大型结构体可用 `G` 快速定位）。

### 固定大小结构体方法 3：用占位字段填充

1. 创建结构体（进入 `Structures` 视图，按 `Ins` 并指定名称）；
1. 创建一个占位字段（例如 dword）；
1. 按 `*` 并输入大小（如果字段大小不是 1 字节，则用总大小除以字段大小）；
1. 取消勾选 `Create as array`，点击 OK。
   ![](assets/2020/10/strsize6.png)
   ![](assets/2020/10/strsize7-e1603443371279.png)

### 从代码自动创建字段

使用方法 2（中间留空隙）的结构体在分析使用固定寄存器基址访问它的函数时尤其有用。

例如，下面的函数使用 rbx 作为结构体的基址：

```asm
ATI6000Controller::initializeProjectDependentResources(void) proc near
  push    rbp
  mov     rbp, rsp
  push    rbx
  sub     rsp, 8
  mov     rbx, rdi
  lea     rax, `vtable for'NI40SharedController
  mov     rdi, rbx        ; this
  call    qword ptr [rax+0C30h]
  test    eax, eax
  jnz     loc_25CD
  mov     rax, [rbx+168h]
  mov     [rbx+4B8h], rax
  mov     rax, [rbx+178h]
  mov     [rbx+4C0h], rax
  mov     rax, [rbx+150h]
  mov     [rbx+4C8h], rax
  mov     [rbx+4B0h], rbx
  mov     rax, [rbx+448h]
  mov     [rbx+4D0h], rax
  mov     rcx, [rbx+170h]
  mov     [rbx+4D8h], rcx
  mov     rcx, [rax]
  mov     [rbx+4E0h], rcx
  mov     eax, [rax+8]
  mov     [rbx+4E8h], rax
  call    NI40PowerPlayManager::createPowerPlayManager(void)
  mov     [rbx+450h], rax
  test    rax, rax
  jnz     short loc_2585
  mov     eax, 0E00002BDh
  jmp     short loc_25CD
---------------------------------------------------------------

loc_2585:
  mov     rcx, [rax]
  lea     rsi, [rbx+4B0h]
  ...
```

要为所有基于 `rbx` 的访问自动创建字段：

1. 选中所有使用 `rbx` 的指令；
1. 在右键菜单中选择 `Structure offset`（或按 `T`）；
1. 在对话框中确保 `Register` 设置为 rbx，选择已创建的结构体（红叉仅表示当前匹配偏移处还没有字段）；
1. 在右侧窗格的右键菜单中选择 `Add missing fields`。

![](assets/2020/10/strsize8.png)
![](assets/2020/10/strsize9.png)

然后，你可以对所有使用该结构体的其他函数重复此操作，以创建其他缺失的字段。

原文地址：https://hex-rays.com/blog/igor-tip-of-the-week-12-creating-structures-with-known-size