Hex-Rays 反编译器最初是为处理标准 C 编译器生成的代码而设计的。在这种情况下，一切（大体上）都是有序的：调用约定是已知且标准化的，函数参数会按照 ABI 规则传递。

然而，现实并不总是如此简单：

- 即使是来自标准编译器的代码，也可能包含使用非标准位置传递参数的辅助函数
- 可能有汇编编写的代码
- 编译器的全程序优化（Whole Program Optimization）可能会为高频调用的函数使用自定义调用约定
- 使用非 C/C++ 编译器生成的代码可能采用完全不同的调用约定（例如 Go 语言）

因此，需要在反编译器中指定自定义调用约定，以便在遇到这些情况时仍能生成可读的输出。IDA 与反编译器因此增加了指定自定义调用约定的功能。

### Usercall

最常用的自定义调用约定是通过关键字 `__usercall` 指定的。基本语法如下：

```c
{return type} __usercall funcname@<return argloc>({type} arg1, {type} arg2@<argloc>, ...);
```

其中 argloc 可以是：

- 处理器寄存器名，例如 `eax`、`ebx`、`esi` 等（某些情况下也可使用标志寄存器，如 `zf`、`sf`、`cf` 等）
- 寄存器对（用冒号分隔），如 `<edx:eax>`

寄存器大小应与参数或返回值类型匹配（如果函数返回 void，则省略返回值位置）

未指定位置的参数默认按常规规则从栈上传递。

### 分散的参数位置（Scattered argument locations）

在复杂情况下，大型参数（如结构体实例）可能会分布在多个寄存器和/或栈槽中传递。这时可以使用以下描述符：

- **部分寄存器位置**：`argoff:register^regoff.size`
- **部分栈位置**：`argoff:^stkoff.size`
- **位置列表**：用逗号分隔的多个部分寄存器和/或栈位置，覆盖整个参数

其中：

- `argoff` – 参数内的偏移
- `stkoff` – 栈帧内的偏移（第一个栈参数偏移为 0）
- `register` – 用于传递部分参数的寄存器名
- `regoff` – 寄存器内的偏移
- `size` – 该部分参数的字节数

如果没有歧义（即使用整个寄存器），`regoff` 和 `size` 可省略。

示例：一个 12 字节的结构体通过 `RDI` 和 `RSI` 传递，可写为：

```c
void __usercall myfunc(struc_1 s@<0:rdi, 8:rsi.4>);
```

### Userpurge

`__userpurge` 与 `__usercall` 类似，但假定 被调用方 会调整栈以清理传递在栈上的参数（类似于 x86 中 `__cdecl` 与 `__stdcall` 的区别）。

### 被破坏的寄存器（Spoiled registers）

编译器或操作系统 ABI 通常会指定哪些寄存器是调用者保存（caller-saved）的，即函数调用可能会破坏（clobber）它们。

一般来说，任何可用于参数传递或返回值的寄存器都可能被破坏，因为被调用函数可能会调用其他函数。

例如，在 x86 上，`EAX`、`ECX` 和 `EDX` 默认被视为会被破坏，反编译器会认为它们在调用后值不确定。

如果实际情况不同，可以用 `__spoils<{reglist}>` 告诉反编译器：

如果函数不破坏任何寄存器：

```
void __spoils<> func();
```

如果自定义的 `memcpy` 会使用 `esi` 和 `edi` 且不保存恢复它们：

```c
int __usercall __spoils<> g@<esi>();
```

### 小结

这篇技巧介绍了如何在 IDA/Hex-Rays 中定义 自定义调用约定，包括：

- `__usercall` 与 `__userpurge` 的语法与区别
- 如何指定寄存器、寄存器对、部分寄存器/栈位置
- 如何声明被破坏的寄存器（`__spoils`）

掌握这些技巧，可以让反编译器在面对非标准调用约定（如手写汇编、Go 语言、编译器优化产物）时，依然生成准确且可读的伪代码，从而大幅提升逆向分析效率。

参考: [Set function/item type](https://hex-rays.com/products/ida/support/idadoc/1361.shtml) and [Scattered argument locations](https://hex-rays.com/products/ida/support/idadoc/1492.shtml) in IDA Help.

原文地址：https://hex-rays.com/blog/igors-tip-of-the-week-51-custom-calling-conventions
