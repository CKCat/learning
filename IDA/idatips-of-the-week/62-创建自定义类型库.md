之前我们讨论过如何使用 IDA 自带的类型库，但如果遇到一些不常见或自定义的 API 或 SDK，而这些库没有覆盖该怎么办呢？

在这种情况下，可以使用 `tilib` 工具（IDA Pro 用户可从下载中心获取）。

### Creating type libraries  创建类型库

`tilib` 是一个功能强大的命令行工具，完整的选项列表看起来可能有些吓人：

```bash
Type Information Library Utility v1.227 Copyright (c) 2000-2021 Hex-Rays
usage: tilib [-sw] til-file
  -c     create til-file              -t...  set til-file title
  -h...  parse .h file                -P     C++ mode (not ready yet)
  -D...  define a symbol              -I...  list of include dirs
  -M...  create macro defs file       -x     external display types
  -i     internal display types       -z     debug .h file parsing (use it!)
  -B...  dump bad macro defs          -q     internal check: unpack types
  -C...  compiler info(-C? help)      -G...  mangling format (n=org.name)
  -m...  parse macro defs file        -S     strip macro table
  -dt... delete type definition       -rtX:Y rename type X as Y
  -ds... delete symbol definition     -rsX:Y rename symbol X as Y
  -b...  use base til                 -o...  directory with til files
  -l[1csxf] show til-file contents; 1-with decorated names, c-as c code
           s-dump struct layout, x-exercise udt serialization, f-dump funcarg locations
  -v     verbose                      -e     ignore errors
  -R     allow redeclarations         -n     ignore til macro table
  -u+    uncompress til-file          -u-    compress til-tile
  -U     set 'universal til' bit      -em    suppress macro creation errors
  -#     enable ordinal types         -#-    disable ordinal types
  -p...  load types from PDB (Win32)  -TL    lower existing type
  -TAL   assume low level types       -TH    keep high types
  -g[nb]X:Y move macro X (regex) to group Y; n-name, b-body
   @...  response file with switches
example: tilib -c -Cc1 -hstdio.h stdio.til
```

示例：

```bash
tilib -c -Cc1 -hstdio.h stdio.til
```

这条命令会通过解析 `stdio.h` 头文件（以 Visual C++ 编译器模式）来创建一个 `stdio.til` 类型库。

### 高级选项

在简单场景下（例如单个独立头文件），上述命令就能工作。但在真实 SDK 中，往往会遇到更多问题，需要额外选项：

- 包含目录：`-I<目录>`（可多次指定）
- 预处理器定义：`-Dname[=value]` （也可以写在一个新的头文件里，用 `#define` 定义，再 `#include` 其他头文件）

### 响应文件

为了避免每次都重复输入相同的选项，可以使用 响应文件。 响应文件中每行写一个命令行选项，然后用 `@` 引用：

```bash
tilib @vc32.cfg -c -hinput.h output.til
```

`tilib` 包中自带了 Visual C++（32/64 位）、GCC 和 Borland C++ 的示例响应文件。

### 检查类型库

可以用 `-l` 参数查看 `.til` 文件内容：

```bash
tilib -l mylib.til
```

### 在 IDA 中使用自定义类型库

将生成的 `.til` 文件复制到 IDA 的 `til/<processor>` 子目录下即可。 例如，x86/x64 的库应放在 `til/pc` 目录下。 之后，在 IDA 中执行 `Load type library` 命令时，就能看到新库了。

### 高级示例

有用户写过一篇关于为 Apache 模块生成类型库的详细文章： 👉 GitHub 项目：[apache-module-ida-til](https://github.com/trou/apache-module-ida-til)

另外，`tilib` 包中的 `readme.txt` 还介绍了更高级的用法，例如从一组宏定义生成枚举。

原文地址：https://hex-rays.com/blog/igors-tip-of-the-week-62-creating-custom-type-libraries
