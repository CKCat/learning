ä¹‹å‰æˆ‘ä»¬è®¨è®ºè¿‡å¦‚ä½•ä½¿ç”¨ IDA è‡ªå¸¦çš„ç±»å‹åº“ï¼Œä½†å¦‚æœé‡åˆ°ä¸€äº›ä¸å¸¸è§æˆ–è‡ªå®šä¹‰çš„ API æˆ– SDKï¼Œè€Œè¿™äº›åº“æ²¡æœ‰è¦†ç›–è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ `tilib` å·¥å…·ï¼ˆIDA Pro ç”¨æˆ·å¯ä»ä¸‹è½½ä¸­å¿ƒè·å–ï¼‰ã€‚

### Creating type librariesÂ  åˆ›å»ºç±»å‹åº“

`tilib` æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®Œæ•´çš„é€‰é¡¹åˆ—è¡¨çœ‹èµ·æ¥å¯èƒ½æœ‰äº›å“äººï¼š

```bash
Type Information Library Utility v1.227 Copyright (c) 2000-2021 Hex-Rays
usage: tilib [-sw] til-file
  -c     create til-file              -t...  set til-file title
  -h...  parse .h file                -P     C++ mode (not ready yet)
  -D...  define a symbol              -I...  list of include dirs
  -M...  create macro defs file       -x     external display types
  -i     internal display types       -z     debug .h file parsing (use it!)
  -B...  dump bad macro defs          -q     internal check: unpack types
  -C...  compiler info(-C? help)      -G...  mangling format (n=org.name)
  -m...  parse macro defs file        -S     strip macro table
  -dt... delete type definition       -rtX:Y rename type X as Y
  -ds... delete symbol definition     -rsX:Y rename symbol X as Y
  -b...  use base til                 -o...  directory with til files
  -l[1csxf] show til-file contents; 1-with decorated names, c-as c code
           s-dump struct layout, x-exercise udt serialization, f-dump funcarg locations
  -v     verbose                      -e     ignore errors
  -R     allow redeclarations         -n     ignore til macro table
  -u+    uncompress til-file          -u-    compress til-tile
  -U     set 'universal til' bit      -em    suppress macro creation errors
  -#     enable ordinal types         -#-    disable ordinal types
  -p...  load types from PDB (Win32)  -TL    lower existing type
  -TAL   assume low level types       -TH    keep high types
  -g[nb]X:Y move macro X (regex) to group Y; n-name, b-body
   @...  response file with switches
example: tilib -c -Cc1 -hstdio.h stdio.til
```

ç¤ºä¾‹ï¼š

```bash
tilib -c -Cc1 -hstdio.h stdio.til
```

è¿™æ¡å‘½ä»¤ä¼šé€šè¿‡è§£æ `stdio.h` å¤´æ–‡ä»¶ï¼ˆä»¥ Visual C++ ç¼–è¯‘å™¨æ¨¡å¼ï¼‰æ¥åˆ›å»ºä¸€ä¸ª `stdio.til` ç±»å‹åº“ã€‚

### é«˜çº§é€‰é¡¹

åœ¨ç®€å•åœºæ™¯ä¸‹ï¼ˆä¾‹å¦‚å•ä¸ªç‹¬ç«‹å¤´æ–‡ä»¶ï¼‰ï¼Œä¸Šè¿°å‘½ä»¤å°±èƒ½å·¥ä½œã€‚ä½†åœ¨çœŸå® SDK ä¸­ï¼Œå¾€å¾€ä¼šé‡åˆ°æ›´å¤šé—®é¢˜ï¼Œéœ€è¦é¢å¤–é€‰é¡¹ï¼š

- åŒ…å«ç›®å½•ï¼š`-I<ç›®å½•>`ï¼ˆå¯å¤šæ¬¡æŒ‡å®šï¼‰
- é¢„å¤„ç†å™¨å®šä¹‰ï¼š`-Dname[=value]` ï¼ˆä¹Ÿå¯ä»¥å†™åœ¨ä¸€ä¸ªæ–°çš„å¤´æ–‡ä»¶é‡Œï¼Œç”¨ `#define` å®šä¹‰ï¼Œå† `#include` å…¶ä»–å¤´æ–‡ä»¶ï¼‰

### å“åº”æ–‡ä»¶

ä¸ºäº†é¿å…æ¯æ¬¡éƒ½é‡å¤è¾“å…¥ç›¸åŒçš„é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ å“åº”æ–‡ä»¶ã€‚ å“åº”æ–‡ä»¶ä¸­æ¯è¡Œå†™ä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ï¼Œç„¶åç”¨ `@` å¼•ç”¨ï¼š

```bash
tilib @vc32.cfg -c -hinput.h output.til
```

`tilib` åŒ…ä¸­è‡ªå¸¦äº† Visual C++ï¼ˆ32/64 ä½ï¼‰ã€GCC å’Œ Borland C++ çš„ç¤ºä¾‹å“åº”æ–‡ä»¶ã€‚

### æ£€æŸ¥ç±»å‹åº“

å¯ä»¥ç”¨ `-l` å‚æ•°æŸ¥çœ‹ `.til` æ–‡ä»¶å†…å®¹ï¼š

```bash
tilib -l mylib.til
```

### åœ¨ IDA ä¸­ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹åº“

å°†ç”Ÿæˆçš„ `.til` æ–‡ä»¶å¤åˆ¶åˆ° IDA çš„ `til/<processor>` å­ç›®å½•ä¸‹å³å¯ã€‚ ä¾‹å¦‚ï¼Œx86/x64 çš„åº“åº”æ”¾åœ¨ `til/pc` ç›®å½•ä¸‹ã€‚ ä¹‹åï¼Œåœ¨ IDA ä¸­æ‰§è¡Œ `Load type library` å‘½ä»¤æ—¶ï¼Œå°±èƒ½çœ‹åˆ°æ–°åº“äº†ã€‚

### é«˜çº§ç¤ºä¾‹

æœ‰ç”¨æˆ·å†™è¿‡ä¸€ç¯‡å…³äºä¸º Apache æ¨¡å—ç”Ÿæˆç±»å‹åº“çš„è¯¦ç»†æ–‡ç« ï¼š ğŸ‘‰ GitHub é¡¹ç›®ï¼š[apache-module-ida-til](https://github.com/trou/apache-module-ida-til)

å¦å¤–ï¼Œ`tilib` åŒ…ä¸­çš„ `readme.txt` è¿˜ä»‹ç»äº†æ›´é«˜çº§çš„ç”¨æ³•ï¼Œä¾‹å¦‚ä»ä¸€ç»„å®å®šä¹‰ç”Ÿæˆæšä¸¾ã€‚

åŸæ–‡åœ°å€ï¼šhttps://hex-rays.com/blog/igors-tip-of-the-week-62-creating-custom-type-libraries
