IDA 对大多数主流编译器生成的 `switch` 模式都有内置支持，通常你无需操心。 但有时你会遇到一些特殊情况：

- 代码由不常见或最新版本的编译器生成
- 某些代码特性阻止了 IDA 自动识别模式

这时，你可能需要手动告诉 IDA 存在一个 `switch`，以便它能正确绘制函数图，并让反编译器生成更清晰的伪代码。

### Switch 模式的组成部分

一个典型的 `switch` 模式通常包含以下组件：

**间接跳转（indirect jump）**

- 实际执行跳转到对应 `case` 处理块的指令
- 通常涉及一个寄存器保存目标地址

**跳转表（jump table）**

- 存储目标块的直接地址，或可计算出这些地址的值（如相对基址的偏移）
- 固定大小（元素数量固定）
- 元素值可能会按 `shift` 值进行缩放
- 有些 `switch` 使用两级表（一级表存索引，二级表存地址）

**输入寄存器（input register）**

- 保存用于确定目标块的初始值
- 最常见的用途是作为跳转表的索引

### Switch 公式

标准 switch 的目标地址计算公式为：

```
target = base +/- (table_element << shift)
```

`base` 和 `shift` 在未使用时可设为 0

### 示例

以下是一个 ARM64 固件片段（间接跳转处用红框标出）：

![](assets/2021/08/switch_arm64.png)

下面是文本格式的相同代码：

```asm
__text:FFFFFF8000039F88 STP X22, X21, [SP,#-0x10+var_20]!
__text:FFFFFF8000039F8C STP X20, X19, [SP,#0x20+var_10]
__text:FFFFFF8000039F90 STP X29, X30, [SP,#0x20+var_s0]
__text:FFFFFF8000039F94 ADD X29, SP, #0x20
__text:FFFFFF8000039F98 MOV X19, X0
__text:FFFFFF8000039F9C BL sub_FFFFFF80000415E4
__text:FFFFFF8000039FA0 B.HI loc_FFFFFF800003A01C
__text:FFFFFF8000039FA4 MOV W20, #0
__text:FFFFFF8000039FA8 ADR X9, byte_FFFFFF8000048593
__text:FFFFFF8000039FAC NOP
__text:FFFFFF8000039FB0 ADR X10, loc_FFFFFF8000039FC0
__text:FFFFFF8000039FB4 LDRB W11, [X9,X8]
__text:FFFFFF8000039FB8 ADD X10, X10, X11,LSL#2
__text:FFFFFF8000039FBC BR X10
```

分析：

- `X10` 是跳转目标寄存器
- `X11` 来自 `LDRB W11, [X9,X8]`，即从 `X9` 指向的表中按 `X8` 索引取值
- 表元素左移 2 位后加到基址 `X10`
- 跳转表位于 `byte_FFFFFF8000048593`
- 基址为 `loc_FFFFFF8000039FC0`
- `shift` 值为 2
- 元素数量为 8（可通过范围检查得出）
- 输入寄存器为 `X8`（或其 32 位部分 `W8`）

在间接跳转指令上，选择 `Edit > Other > Specify switch idiom…` 手动指定 `switch`。

- 在对话框中填写基址、表地址、`shift` 值、元素数量等
- 可用 C 语法（如 `0x…`）或标签名

![](assets/2021/08/switch_dlg.png)

确认后，IDA 会标注 `switch`，函数图更新，显示新可达节点

![](assets/2021/08/switch_graph.png)

可用 `Ctrl+J` 查看间接跳转的目标列表

![](assets/2021/08/switch_xrefs.png)

#### 附加选项

- `separate value table is present`：两级表模式
- `signed jump table elements`：表元素需符号扩展（如 ARM 的 `LDRSB`、`LDRSW` 或 x86 的 `movsx`）
- `Subtract table elements`：从基址减去表值
- `Table element is insn`：表中存放的是指令而非数据（如旧 ARM 直接修改 `PC` 的跳转）

### 可选值

- `Input register of switch`：输入寄存器（若需反编译器正确解析 switch 必须指定）
- `First(lowest) input value`：输入寄存器对应跳转表第 0 项的值
- `default jump address`：输入值超出范围时的默认跳转地址

原文地址：https://hex-rays.com/blog/igors-tip-of-the-week-53-manual-switch-idioms
