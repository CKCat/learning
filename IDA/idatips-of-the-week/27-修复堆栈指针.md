åœ¨ IDA ä¸­ï¼Œæ­£ç¡®çš„ æ ˆå˜åŒ–ä¿¡æ¯ å¯¹äºåˆ†æè‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯åç¼–è¯‘æ—¶ã€‚å¦‚æœæ ˆæŒ‡é’ˆï¼ˆSPï¼‰çš„è¿½è¸ªå‡ºé”™ï¼Œå°±å¯èƒ½å‡ºç°æç¤ºï¼š

`sp-analysis failed`ï¼ˆæ ˆåˆ†æå¤±è´¥ï¼‰
![](assets/2021/02/sp_analysis_failed.png)

`positive sp value has been detected`ï¼ˆæ£€æµ‹åˆ°æ­£çš„ sp å€¼ï¼‰

![](assets/2021/02/sp_positive_sp.png)

å³ä½¿æœ‰è°ƒè¯•ç¬¦å·ï¼Œä¹Ÿå¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚æœ¬æ–‡å±•ç¤ºäº†å¦‚ä½•æ£€æµ‹å¹¶ä¿®å¤è¿™äº›é—®é¢˜ã€‚

### å¦‚ä½•æ£€æµ‹é—®é¢˜

åˆ‡æ¢åˆ°åæ±‡ç¼–è§†å›¾ã€‚

1.  åœ¨ `Options > General > Disassembly line parts` ä¸­å¯ç”¨ `Stack pointer` æ˜¾ç¤ºã€‚
    ![](assets/2021/02/sp_disasmopt.png)
2.  è§‚å¯Ÿæ¯æ¡æŒ‡ä»¤å‰çš„ `SP delta`ï¼ˆæ ˆåç§»é‡ï¼‰ã€‚

æ­£å¸¸æƒ…å†µ

- `push` æŒ‡ä»¤ï¼š`SP delta` å¢åŠ ï¼ˆä¾‹å¦‚ `push eax` å¢åŠ  4ï¼‰ã€‚
- `pop` æŒ‡ä»¤ï¼š`SP delta` å‡å°‘ç›¸åŒæ•°å€¼ã€‚
- `call` æŒ‡ä»¤ï¼šå¯èƒ½å‡å°‘ `SP`ï¼ˆå¦‚ `__stdcall` è°ƒç”¨ï¼‰ï¼Œæˆ–ä¿æŒä¸å˜ï¼Œç¨åå†è°ƒæ•´ã€‚
- è·³è½¬çš„ä¸¤ç«¯ `SP delta` åº”è¯¥ä¸€è‡´ã€‚
- å‡½æ•°å…¥å£å’Œè¿”å›å¤„ `SP delta` åº”ä¸º 0ã€‚
- åœ¨å‡½æ•°ä½“ä¸­ï¼Œ`SP delta` åº”ä¿æŒç¨³å®šï¼Œé™¤äº†è°ƒç”¨å‰åçŸ­æš‚çš„å˜åŒ–ã€‚

åœ¨ `notepad.exe` çš„ä¸€ä¸ªä¾‹å­ä¸­ï¼ŒæŸä¸ªå—çš„ `SP delta` åœ¨è°ƒç”¨åä» `00C` å˜æˆ `008`ã€‚

è¡¨é¢ä¸Šçœ‹åˆç†ï¼ˆ`@4` è¡¨ç¤º `__stdcall`ï¼Œä¼šæ¸…ç† 4 å­—èŠ‚å‚æ•°ï¼‰ã€‚ä½†å®é™…å‡½æ•°ä½¿ç”¨çš„æ˜¯å¯„å­˜å™¨å‚æ•°ï¼ˆå¯èƒ½å›  é“¾æ¥æ—¶ä»£ç ç”Ÿæˆ `LTO` ä¼˜åŒ–ï¼Œå°† `__stdcall` è½¬æ¢ä¸º `__fastcall`ï¼‰ã€‚

```asm
00C mov     ecx, offset dword_41D180
00C call    _TraceLoggingRegister@4 ; TraceLoggingRegister(x)
008 push    offset _TraceLogger__GetInstance____2____dynamic_atexit_destructor_for__s_instance__ ; void (__cdecl *)()
00C call    _atexit
00C pop     ecx
008 push    ebx
00C call    __Init_thread_footer
00C pop     ecx
008 jmp     short loc_406F9D
```

åœ¨å¦ä¸€ä¸ªä¾‹å­ä¸­ï¼Œè°ƒç”¨å `SP delta` å˜ä¸ºè´Ÿæ•°ã€‚

![](assets/2021/02/sp_analysis_positive.png)

IDA è¯¯åˆ¤å‡½æ•°æ¶ˆè€—äº† `0x14` å­—èŠ‚ï¼Œä½†å®é™…ä¸Šåªæœ‰ 3 æ¬¡ pushï¼ˆ12 å­—èŠ‚ï¼‰ã€‚è¿›å…¥å‡½æ•°ä½“å¯è§å®ƒä»¥ `retn 0Ch` ç»“æŸï¼Œè¯´æ˜æ­£ç¡®çš„å‚æ•°å¤§å°æ˜¯ 12 å­—èŠ‚ã€‚

### ä¿®å¤æ–¹æ³•

#### å±€éƒ¨ä¿®å¤

- åœ¨å‡ºé”™çš„æŒ‡ä»¤ä¸ŠæŒ‰ `Altâ€“K`ï¼ˆ`Edit > Functions > Change stack pointerâ€¦`ï¼‰ã€‚
- è¾“å…¥æ­£ç¡®çš„ `SP` å˜åŒ–å€¼ã€‚

ç¤ºä¾‹ï¼šç¬¬ä¸€ä¸ªä¾‹å­åº”æ”¹ä¸º 0ï¼Œç¬¬äºŒä¸ªä¾‹å­åº”æ”¹ä¸º 12 (0xC)ã€‚

#### å…¨å±€ä¿®å¤

- å¦‚æœåŒä¸€ä¸ªå‡½æ•°åœ¨å¤šä¸ªè°ƒç”¨ç‚¹éƒ½å¯¼è‡´æ ˆä¸å¹³è¡¡ï¼Œå¯ä»¥ä¿®æ”¹å‡½æ•°å±æ€§ã€‚
- æŒ‰ `Altâ€“P`ï¼ˆ`Edit > Functions > Edit functionâ€¦`ï¼‰ï¼Œè°ƒæ•´ `Purged bytes` å€¼ã€‚

![](assets/2021/02/sp_purged.png)

ğŸ‘‰ æ€»ç»“ï¼š å³ä½¿æœ‰ PDB ç¬¦å·ï¼Œä¹Ÿä¸èƒ½ä¿è¯æ ˆåˆ†æå®Œå…¨æ­£ç¡®ã€‚å­¦ä¼šæ£€æŸ¥ SP delta å¹¶åœ¨å¿…è¦æ—¶æ‰‹åŠ¨ä¿®å¤ï¼Œæ˜¯ä¿è¯åç¼–è¯‘ç»“æœå¯é çš„å…³é”®ã€‚

åŸæ–‡åœ°å€ï¼šhttps://hex-rays.com/blog/igors-tip-of-the-week-27-fixing-the-stack-pointer
